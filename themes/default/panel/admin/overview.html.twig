{% extends '@EasyAdmin/page/content.html.twig' %}

{% block title %}| {{ 'pteroca.admin.overview.title'|trans }}{% endblock %}

{% block content %}
    <div class="container-fluid mt-4">
        <!-- Header Section -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-header rounded-3 p-4 mb-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle me-3">
                                <i class="fas fa-chart-line p-3 text-white"></i>
                            </div>
                            <div>
                                <h4 class="mb-1 fw-bold">{{ 'pteroca.admin.overview.title'|trans }}</h4>
                                <p class="text-muted mb-0">System statistics and information</p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a class="btn btn-outline-secondary" href="{{ path('panel') }}">
                                <i class="fas fa-arrow-left me-2"></i>{{ 'pteroca.system.back'|trans }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <!-- Statistics Cards -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small mb-1">
                                    <i class="fa-solid fa-server me-1"></i>
                                    {{ 'pteroca.admin.overview.servers'|trans }}
                                </div>
                                <div class="fw-bold fs-5">{{ statistics.activeServers }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small mb-1">
                                    <i class="fa-solid fa-users me-1"></i>
                                    {{ 'pteroca.admin.overview.users'|trans }}
                                </div>
                                <div class="fw-bold fs-5">{{ statistics.usersRegisteredLastMonth }}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">{{ 'pteroca.admin.overview.last_30_days'|trans }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small mb-1">
                                    <i class="fa-solid fa-money-bill me-1"></i>
                                    {{ 'pteroca.admin.overview.payments'|trans }}
                                </div>
                                <div class="fw-bold fs-5">{{ statistics.paymentsCreatedLastMonth }}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">{{ 'pteroca.admin.overview.last_30_days'|trans }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-body p-3">
                        <div class="mb-2">
                            <div class="text-muted small">
                                <i class="fa-solid fa-life-ring me-1"></i>
                                {{ 'pteroca.admin.overview.links'|trans }}
                            </div>
                        </div>
                        <div class="d-flex flex-column gap-2" style="font-size: 0.875rem;">
                            <a href="https://docs.pteroca.com/" target="_blank" class="text-decoration-none">
                                <i class="fas fa-external-link-alt me-2 text-muted" style="font-size: 0.7rem;"></i>
                                Documentation
                            </a>
                            <a href="https://discord.gg/Gz5phhuZym" target="_blank" class="text-decoration-none">
                                <i class="fas fa-external-link-alt me-2 text-muted" style="font-size: 0.7rem;"></i>
                                Discord Support
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-4">
            <!-- Payment Overview -->
            <div class="col-12 col-xl-8">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm rounded-3">
                            <div class="card-header border-0 p-4">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-credit-card me-2 text-primary"></i>
                                        <h5 class="mb-0 fw-semibold">{{ 'pteroca.admin.overview.payment_overview'|trans }}</h5>
                                    </div>
                                    <a href="{{ path('panel', { crudAction: 'index', crudControllerFqcn: 'App\\Core\\Controller\\Panel\\PaymentCrudController' }) }}" class="btn btn-primary btn-sm">
                                        {{ 'pteroca.admin.overview.view_all'|trans }} <i class="fa fa-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                {% if not statistics.lastPayments %}
                                    <div class="alert alert-info border-0 rounded-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        {{ 'pteroca.admin.overview.no_payments'|trans }}
                                    </div>
                                {% else %}
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                            <tr>
                                                <th scope="col" class="fw-semibold">#</th>
                                                <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.user'|trans }}</th>
                                                <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.amount'|trans }}</th>
                                                <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.currency'|trans }}</th>
                                                <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.status'|trans }}</th>
                                                <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.date'|trans }}</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for payment in statistics.lastPayments %}
                                                <tr>
                                                    <th scope="row" class="fw-semibold">{{ payment.id }}</th>
                                                    <td>{{ payment.user.email }}</td>
                                                    <td class="fw-semibold">{{ payment.amount|number_format(2, ',', ' ') }}</td>
                                                    <td><span class="badge bg-light text-dark">{{ payment.currency }}</span></td>
                                                    <td>
                                                        {% if payment.status == 'paid' %}
                                                            <span class="badge badge-success">
                                                                <i class="fas fa-check me-1"></i>{{ 'pteroca.recharge.transaction_paid'|trans }}
                                                            </span>
                                                        {% else %}
                                                            <span class="badge badge-danger">
                                                                <i class="fas fa-times me-1"></i>{{ 'pteroca.recharge.transaction_unpaid'|trans }}
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-muted">{{ payment.createdAt|date('Y-m-d H:i') }}</td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Last Registered Users -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm rounded-3">
                            <div class="card-header border-0 p-4">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-plus me-2 text-success"></i>
                                        <h5 class="mb-0 fw-semibold">{{ 'pteroca.admin.overview.last_registered_users'|trans }}</h5>
                                    </div>
                                    <a href="{{ path('panel', { crudAction: 'index', crudControllerFqcn: 'App\\Core\\Controller\\Panel\\UserCrudController' }) }}" class="btn btn-primary btn-sm">
                                        {{ 'pteroca.admin.overview.view_all'|trans }} <i class="fa fa-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                        <tr>
                                            <th scope="col" class="fw-semibold">#</th>
                                            <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.user'|trans }}</th>
                                            <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.balance'|trans }}</th>
                                            <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.status'|trans }}</th>
                                            <th scope="col" class="fw-semibold">{{ 'pteroca.admin.overview.date'|trans }}</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for user in statistics.lastRegisteredUsers %}
                                            <tr>
                                                <th scope="row" class="fw-semibold">{{ user.id }}</th>
                                                <td>{{ user.email }}</td>
                                                <td class="fw-semibold">{{ user.balance|number_format(2, ',', ' ') }} {{ get_currency() }}</td>
                                                <td>
                                                    {% if user.isVerified %}
                                                        <span class="badge badge-success">
                                                            <i class="fas fa-check me-1"></i>{{ 'pteroca.admin.overview.verified'|trans }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge badge-warning">
                                                            <i class="fas fa-clock me-1"></i>{{ 'pteroca.admin.overview.unverified'|trans }}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-muted">{{ user.createdAt|date('Y-m-d H:i') }}</td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Information -->
            <div class="col-12 col-xl-4">
                <div class="card border-0 shadow-sm rounded-3 h-100">
                    <div class="card-header border-0 p-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-server me-2 text-info"></i>
                            <h5 class="mb-0 fw-semibold">{{ 'pteroca.admin.overview.system'|trans }}</h5>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold text-muted">PteroCA Version:</span>
                                <div>
                                    <span class="fw-bold">v{{ get_app_version() }}</span>
                                    <span id="pteroca-version-result"></span>
                                </div>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold text-muted">PteroCA Pterodactyl Addon:</span>
                                <div>
                                    <span class="fw-bold" style="word-break: break-word; font-size: 0.9em; text-align: right;">
                                        {% if systemInformation.pteroca_plugin.version %}
                                            v{{ systemInformation.pteroca_plugin.version }}
                                        {% else %}
                                            <span class="text-muted">
                                                <i class="fa-solid fa-question me-1"></i>{{ 'pteroca.admin.overview.pteroca_plugin_not_detected'|trans }}
                                            </span>
                                        {% endif %}
                                    </span>
                                    {% if systemInformation.pteroca_plugin.version %}
                                        <span id="addon-version-result"></span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold text-muted">Pterodactyl API:</span>
                                <span class="{{ systemInformation.pterodactyl.status ? 'text-success' : 'text-danger' }} fw-semibold">
                                    {{ systemInformation.pterodactyl.status ? '<i class="fa-solid fa-check me-1"></i>OK' : '<i class="fa-solid fa-x me-1"></i>Error' }}
                                </span>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold text-muted">PHP:</span>
                                <span class="fw-bold" style="word-break: break-word; font-size: 0.9em; text-align: right;">{{ systemInformation.php.version }}</span>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold text-muted">Database:</span>
                                <span class="fw-bold" style="word-break: break-word; font-size: 0.9em; text-align: right;">{{ systemInformation.database.version }}</span>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold text-muted">Web:</span>
                                <span class="fw-bold" style="word-break: break-word; font-size: 0.9em; text-align: right;">{{ systemInformation.webserver }}</span>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="mb-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold text-muted">Host:</span>
                                <span class="fw-bold" style="word-break: break-word; font-size: 0.9em; text-align: right;">{{ systemInformation.os|join(' ') }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block body_javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const currentVersion = '{{ get_app_version() }}',
                pterocaVersionResult = document.getElementById('pteroca-version-result'),
                addonVersionResult = document.getElementById('addon-version-result'),
                currentAddonVersion = '{{ systemInformation.pteroca_plugin.version ?? '' }}';

            fetch('{{ path('check_version') }}')
                .then(response => response.json())
                .then(data => {
                    // Check PteroCA version
                    pterocaVersionResult.innerHTML = ' <i class="fa fa-x"></i> {{ 'pteroca.admin.overview.update_available'|trans }}';
                    pterocaVersionResult.classList.add('text-danger');
                    pterocaVersionResult.classList.remove('text-success');
                    if (compareVersions(currentVersion, data.latestVersion.replace('v', '')) >= 0) {
                        pterocaVersionResult.innerHTML = ' <i class="fa fa-check"></i> {{ 'pteroca.admin.overview.up_to_date'|trans }}';
                        pterocaVersionResult.classList.add('text-success');
                        pterocaVersionResult.classList.remove('text-danger');
                    } else {
                        pterocaVersionResult.innerHTML = ' <i class="fa fa-x"></i> {{ 'pteroca.admin.overview.update_available'|trans }}';
                        pterocaVersionResult.classList.add('text-danger');
                        pterocaVersionResult.classList.remove('text-success');
                    }

                    if (addonVersionResult && currentAddonVersion && data.pterodactylAddonVersion) {
                        const latestAddonVersion = data.pterodactylAddonVersion.latestVersion.replace('v', '');
                        if (compareVersions(currentAddonVersion, latestAddonVersion) >= 0) {
                            addonVersionResult.innerHTML = ' <i class="fa fa-check"></i> {{ 'pteroca.admin.overview.up_to_date'|trans }}';
                            addonVersionResult.classList.add('text-success');
                            addonVersionResult.classList.remove('text-danger');
                        } else {
                            addonVersionResult.innerHTML = ' <i class="fa fa-x"></i> {{ 'pteroca.admin.overview.update_available'|trans }}';
                            addonVersionResult.classList.add('text-danger');
                            addonVersionResult.classList.remove('text-success');
                        }
                    }
                });
        });

        function compareVersions(version1, version2) {
            const v1Parts = version1.split('.').map(Number);
            const v2Parts = version2.split('.').map(Number);

            for (let i = 0; i < 3; i++) {
                if (v1Parts[i] > v2Parts[i]) {
                    return 1;
                } else if (v1Parts[i] < v2Parts[i]) {
                    return -1;
                }
            }

            return 0;
        }
    </script>
{% endblock %}
