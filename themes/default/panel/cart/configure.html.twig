{% extends '@EasyAdmin/page/content.html.twig' %}

{% block title %}| {{ 'pteroca.cart_configuration.title'|trans }} - {{ product.name }}{% endblock %}

{% block content %}
    <div class="container-fluid mt-4">
        <!-- Header Section -->
        <div class="row">
            <div class="col-12">
                <div class="bg-light rounded-3 p-4 mb-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle me-3">
                                <i class="fas fa-shopping-cart p-3 text-white"></i>
                            </div>
                            <div>
                                <h4 class="mb-1 fw-bold">{{ 'pteroca.cart_configuration.title'|trans }}</h4>
                                <p class="text-muted mb-0">{{ 'pteroca.cart_configuration.description'|trans }}</p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#useVoucherModal">
                                <i class="fa fa-plus me-2"></i>{{ 'pteroca.cart.use_voucher'|trans }}
                            </button>                       
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form action="{{ path('panel', { routeName: 'cart_buy' }) }}" method="post">
            <input type="hidden" name="id" value="{{ product.id }}">
            <input type="hidden" name="voucher" value="" id="voucher-code" data-voucher-type="server_discount">
            
            <div class="row g-4">
                <!-- Product Configuration -->
                <div class="col-lg-8">
                    <!-- Product Information Card -->
                    <div class="card border-0 shadow-sm rounded-3 mb-4">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-server me-2"></i>
                                <h5 class="mb-1 fw-bold text-white">{{ product.name }}</h5>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item border-0 px-0 py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-info bg-opacity-10 rounded-circle me-3">
                                                    <i class="fas fa-memory p-3 text-info"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ 'pteroca.product.ram'|trans }}:</strong>
                                                    <span class="ms-2">{{ product.memory }} MB</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="list-group-item border-0 px-0 py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-warning bg-opacity-10 rounded-circle me-3">
                                                    <i class="fas fa-microchip p-3 text-warning"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ 'pteroca.product.cpu'|trans }}:</strong>
                                                    <span class="ms-2">{{ product.cpu }}%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="list-group-item border-0 px-0 py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-success bg-opacity-10 rounded-circle me-3">
                                                    <i class="fas fa-hdd p-3 text-success"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ 'pteroca.product.disk'|trans }}:</strong>
                                                    <span class="ms-2">{{ product.diskSpace }} MB</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="list-group-item border-0 px-0 py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-secondary bg-opacity-10 rounded-circle me-3">
                                                    <i class="fas fa-exchange-alt p-3 text-secondary"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ 'pteroca.product.swap'|trans }}:</strong>
                                                    <span class="ms-2">{{ product.swap }} MB</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item border-0 px-0 py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-primary bg-opacity-10 rounded-circle me-3">
                                                    <i class="fas fa-network-wired p-3 text-primary"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ 'pteroca.product.ports'|trans }}:</strong>
                                                    <span class="ms-2">{{ product.ports }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="list-group-item border-0 px-0 py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-danger bg-opacity-10 rounded-circle me-3">
                                                    <i class="fas fa-save p-3 text-danger"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ 'pteroca.product.backups'|trans }}:</strong>
                                                    <span class="ms-2">{{ product.backups }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="list-group-item border-0 px-0 py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-warning bg-opacity-10 rounded-circle me-3">
                                                    <i class="fas fa-database p-3 text-warning"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ 'pteroca.product.databases'|trans }}:</strong>
                                                    <span class="ms-2">{{ product.dbCount }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Card -->
                    <div class="card border-0 shadow-sm rounded-3">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-cogs me-2"></i>
                                <h5 class="mb-1 fw-bold text-white">{{ 'pteroca.cart_configuration.configuration'|trans }}</h5>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <input type="hidden" name="product" value="{{ product.id }}">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label for="duration" class="form-label fw-semibold">
                                        <i class="fas fa-clock me-2 text-primary"></i>
                                        {{ 'pteroca.cart_configuration.period'|trans }}
                                    </label>
                                    <select id="duration" name="duration" class="form-select form-select-lg">
                                        {% for price in product.prices %}
                                            {% if price.type.value == 'static' %}
                                                <option value="{{ price.id }}" data-type="{{ price.type.value }}" data-value="{{ price.value }}" data-unit="{{ price.unit.value }}" data-price="{{ price.price }}" {% if request.duration is defined and request.duration == price.id %}selected{% endif %}>
                                                    {{ price.value }} {{ ('pteroca.product.' ~ price.unit.value)|trans }} - {{ price.price|number_format(2, ',', ' ') }} {{ get_currency() }}
                                                </option>
                                            {% elseif price.type.value == 'on_demand' %}
                                                <option value="{{ price.id }}" data-type="{{ price.type.value }}" data-value="{{ price.value }}" data-unit="{{ price.unit.value }}" data-price="{{ price.price }}" {% if request.duration is defined and request.duration == price.id %}selected{% endif %}>
                                                    {{ 'pteroca.product.on_demand'|trans }} - {{ price.price|number_format(2, ',', ' ') }} {{ get_currency() }}/{{ 'pteroca.product.minute_short'|trans }}
                                                </option>
                                            {% elseif price.type.value == 'slot' %}
                                                <option value="{{ price.id }}" data-type="{{ price.type.value }}" data-value="{{ price.value }}" data-unit="{{ price.unit.value }}" data-price="{{ price.price }}" {% if request.duration is defined and request.duration == price.id %}selected{% endif %}>
                                                    {{ 'pteroca.store.slot_pricing'|trans }} - {{ price.value }} {{ ('pteroca.product.' ~ price.unit.value)|trans }} - {{ price.price|number_format(2, ',', ' ') }} {{ get_currency() }}/{{ 'pteroca.product.slot'|trans }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="egg" class="form-label fw-semibold">
                                        <i class="fas fa-cog me-2 text-warning"></i>
                                        {{ 'pteroca.product.egg'|trans }}
                                    </label>
                                    <select id="egg" name="egg" class="form-select form-select-lg">
                                        {% for egg in eggs %}
                                            <option value="{{ egg.id }}" {% if request.egg is defined and request.egg == egg.id %}selected{% endif %}>
                                                {{ egg.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    {% if product.allowChangeEgg %}
                                        <div class="form-text">
                                            <i class="fas fa-info-circle text-info me-1"></i>
                                            {{ 'pteroca.product.egg_hint'|trans }}
                                        </div>
                                    {% endif %}
                                </div>

                                {% if hasSlotPrices %}
                                <div class="col-md-12">
                                    {% include 'components/slot_selector.html.twig' with {
                                        'initialValue': 1,
                                        'maxValue': 32,
                                        'minValue': 1,
                                        'showBadge': true
                                    } %}
                                </div>
                                {% endif %}

                                <div class="col-md-6">
                                    <label for="server-name" class="form-label fw-semibold">
                                        <i class="fas fa-tag me-2 text-success"></i>
                                        {{ 'pteroca.cart_configuration.server_name'|trans }}
                                    </label>
                                    <input type="text" class="form-control form-control-lg" id="server-name" name="server-name" placeholder="{{ product.name }}">
                                </div>

                                <div class="col-md-6">
                                    <label for="auto-renewal" class="form-label fw-semibold">
                                        <i class="fas fa-sync-alt me-2 text-info"></i>
                                        {{ 'pteroca.cart_configuration.auto_renewal'|trans }}
                                    </label>
                                    <select id="auto-renewal" name="auto-renewal" class="form-select form-select-lg">
                                        <option value="1">
                                            {{ 'pteroca.cart_configuration.enable'|trans }}
                                        </option>
                                        <option value="0">
                                            {{ 'pteroca.cart_configuration.disable'|trans }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-3 sticky-top" style="top: 20px;">
                        <div class="card-header bg-success text-white">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-receipt me-2"></i>
                                <h5 class="mb-1 fw-bold text-white">{{ 'pteroca.cart_configuration.order_summary'|trans }}</h5>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <!-- Product Name -->
                            <div class="mb-3">
                                <h6 class="fw-bold">{{ product.name }}</h6>
                                <div id="selected-dates" class="small"></div>
                            </div>
                            
                            <hr class="my-3">
                            
                            <!-- Period and Price -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small>{{ 'pteroca.cart_configuration.period'|trans }}:</small>
                                        <div id="selected-duration" class="fw-semibold"></div>
                                    </div>
                                    <div class="text-end">
                                        <span id="selected-price" class="fw-semibold"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Discount Section -->
                            <div class="mb-3 d-none" id="applied-discount">
                                <hr class="my-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-success">{{ 'pteroca.product.discount'|trans }}</small>
                                        <div class="small text-muted">
                                            <span id="applied-discount-code"></span> (-<span id="applied-discount-value"></span>%)
                                            <i class="fa fa-question-circle-o ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ 'pteroca.product.discount_hint'|trans }}"></i>
                                            <i class="fa fa-close ms-1 hover-pointer text-danger" id="applied-discount-remove"></i>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="text-success">-<span id="applied-discount-amount"></span> {{ get_currency() }}</span>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Total -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">{{ 'pteroca.product.total'|trans }}:</span>
                                    <span id="selected-summary" class="fw-bold text-primary fs-4"></span>
                                </div>
                            </div>

                            <!-- Alerts -->
                            {% if not isProductAvailable %}
                                <div class="alert alert-warning border-0 shadow-sm mb-3" role="alert">
                                    <i class="fa fa-exclamation-triangle me-2"></i>
                                    {{ 'pteroca.product.not_available'|trans }}
                                </div>
                            {% endif %}

                            <div class="alert alert-warning border-0 shadow-sm mb-3 d-none" data-alert="not_enough_balance" role="alert">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                {{ 'pteroca.product.not_enough_balance'|trans }}
                            </div>

                            <!-- Order Button -->
                            <div class="d-grid">
                                <button type="submit" id="order-submit" class="btn btn-success btn-lg rounded-pill fw-semibold" disabled>
                                    <i class="fa fa-shopping-basket me-2"></i>
                                    {{ 'pteroca.product.order_now'|trans }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    {% include 'components/use_voucher_modal.html.twig' %}
    {% include 'panel/cart/components/apply_discount.html.twig' %}
{% endblock %}

{% block body_javascript %}
    <script>
        const unitTranslations = {
            minutes: '{{ 'pteroca.product.minutes'|trans }}',
            hours: '{{ 'pteroca.product.hours'|trans }}',
            days: '{{ 'pteroca.product.days'|trans }}',
        },
            currentUserBalance = parseFloat('{{ app.user.balance }}'),
            isProductAvailable = {{ isProductAvailable ? 'true' : 'false' }};

        {% if hasSlotPrices %}
        const eggsConfiguration = {{ product.eggsConfiguration|raw }};
        {% endif %}

        document.addEventListener('DOMContentLoaded', function () {
            const durationSelect = document.getElementById('duration');
            {% if hasSlotPrices %}
            const slotSelection = document.getElementById('slot-selection');
            const slotsRange = document.getElementById('slots');
            const selectedSlotsDisplay = document.getElementById('selected-slots');
            const eggSelect = document.getElementById('egg');
            
            {% if initialSlots %}
            const initialSlots = {{ initialSlots }};
            if (initialSlots && slotsRange) {
                const slotOptions = Array.from(durationSelect.options).filter(option => 
                    option.getAttribute('data-type') === 'slot'
                );
                if (slotOptions.length > 0) {
                    durationSelect.value = slotOptions[0].value;
                    slotSelection.style.display = 'block';
                    
                    updateMaxSlots();
                    
                    const maxSlots = parseInt(slotsRange.max);
                    const finalSlots = Math.min(initialSlots, maxSlots);
                    slotsRange.value = finalSlots;
                    handleSlotsChange();
                }
            }
            {% endif %}
            {% endif %}

            durationSelect.addEventListener('change', () => {
                removeDiscountCode();
                {% if hasSlotPrices %}
                handleDurationChange();
                {% endif %}
                calculatePrice();
            });
            durationSelect.dispatchEvent(new Event('change'));

            {% if hasSlotPrices %}
            slotsRange.addEventListener('input', function() {
                handleSlotsChange();
                calculatePrice();
            });

            eggSelect.addEventListener('change', function() {
                if (slotSelection.style.display !== 'none') {
                    updateMaxSlots();
                    // Trigger price recalculation after slot maximum changes
                    calculatePrice();
                }
            });

            function updateMaxSlots() {
                const selectedEggId = parseInt(eggSelect.value);
                let maxSlots = 32;
                
                if (eggsConfiguration && eggsConfiguration[selectedEggId]) {
                    const eggConfig = eggsConfiguration[selectedEggId];
                    if (eggConfig.variables && typeof eggConfig.variables === 'object') {
                        for (const variableId in eggConfig.variables) {
                            const variable = eggConfig.variables[variableId];
                            if (variable.slot_variable === 'on' && variable.value) {
                                maxSlots = parseInt(variable.value);
                                break;
                            }
                        }
                    }
                }
                
                // Get current value before updating max
                const currentSlotValue = parseInt(slotsRange.value);
                
                // Update max slots for the range input
                slotsRange.max = maxSlots;
                slotsRange.nextElementSibling.textContent = maxSlots;
                
                // If current value exceeds new maximum, adjust it to the new maximum
                if (currentSlotValue > maxSlots) {
                    slotsRange.value = maxSlots;
                    handleSlotsChange(); // Update the display text
                }
            }

            function handleDurationChange() {
                const selectedOption = durationSelect.options[durationSelect.selectedIndex];
                const priceType = selectedOption.getAttribute('data-type');
                
                if (priceType === 'slot') {
                    slotSelection.style.display = 'block';
                    updateMaxSlots();
                } else {
                    slotSelection.style.display = 'none';
                }
            }

            function handleSlotsChange() {
                const slotsCount = slotsRange.value;
                const slotText = slotsCount === '1' ? '{{ 'pteroca.product.slot'|trans }}' : '{{ 'pteroca.product.slots'|trans }}';
                selectedSlotsDisplay.textContent = `${slotsCount} ${slotText}`;
            }

            handleDurationChange();
            handleSlotsChange();
            {% endif %}

            document.getElementById('applied-discount-remove').addEventListener('click', removeDiscountCode);
        })

        function calculatePrice() {
            const durationSelect = document.getElementById('duration'),
                selectedOption = durationSelect.options[durationSelect.selectedIndex],
                appliedDiscountValue = document.querySelector('#applied-discount-value');
            
            let productPrice = parseFloat(selectedOption.dataset.price);
            
            {% if hasSlotPrices %}
            // Apply slot pricing calculation
            if (selectedOption.dataset.type === 'slot') {
                const slotsRange = document.getElementById('slots');
                if (slotsRange) {
                    const slotQuantity = parseInt(slotsRange.value) || 1;
                    productPrice = productPrice * slotQuantity;
                }
            }
            {% endif %}

            let summaryPrice = productPrice

            if (appliedDiscountValue && appliedDiscountValue.innerText) {
                const discountValue = parseFloat(appliedDiscountValue.innerText);
                if (!isNaN(discountValue)) {
                    let discountPrice = summaryPrice * (discountValue / 100);
                    document.querySelector('#applied-discount-amount').textContent = discountPrice.toFixed(2);
                    summaryPrice -= discountPrice
                }
            }

            const basePrice = parseFloat(selectedOption.dataset.price);
            let durationText = '';
            
            if (selectedOption.dataset.type === 'slot') {
                {% if hasSlotPrices %}
                const slotsRange = document.getElementById('slots');
                const slotQuantity = parseInt(slotsRange.value) || 1;
                const periodText = `${selectedOption.dataset.value} ${unitTranslations[selectedOption.dataset.unit]}`;
                durationText = `${periodText} [${slotQuantity} ${slotQuantity === 1 ? '{{ 'pteroca.product.slot'|trans }}' : '{{ 'pteroca.product.slots'|trans }}'}]`;
                {% endif %}
            } else {
                durationText = `${selectedOption.dataset.value} ${unitTranslations[selectedOption.dataset.unit]}`;
            }

            document.querySelector('#selected-duration').textContent = durationText;
            document.querySelector('#selected-price').textContent = `${productPrice.toFixed(2)} {{ get_currency() }}`;

            // Calculate and display dates for static pricing
            const datesElement = document.querySelector('#selected-dates');
            if (selectedOption.dataset.type === 'static') {
                const startDate = new Date();
                const endDate = new Date();
                const value = parseInt(selectedOption.dataset.value);
                const unit = selectedOption.dataset.unit;

                switch (unit) {
                    case 'days':
                        endDate.setDate(startDate.getDate() + value);
                        break;
                    case 'hours':
                        endDate.setHours(startDate.getHours() + value);
                        break;
                    case 'minutes':
                        endDate.setMinutes(startDate.getMinutes() + value);
                        break;
                }

                const formatDate = (date) => {
                    return date.toLocaleDateString('pl-PL', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                datesElement.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                datesElement.style.display = 'block';
            } else {
                datesElement.style.display = 'none';
            }

            document.querySelector('#selected-summary').textContent = `${summaryPrice.toFixed(2)} {{ get_currency() }}`

            const insufficientBalance = currentUserBalance < summaryPrice;
            document.querySelector('div[data-alert="not_enough_balance"]').classList.toggle('d-none', !insufficientBalance);
            document.querySelector('button#order-submit').disabled = insufficientBalance || !isProductAvailable;
        }
    </script>
{% endblock %}
